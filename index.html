<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POS System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
      #interactive {
        position: relative;
        overflow: hidden;
      }
      
      #interactive video {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        max-width: 100%;
        border-radius: 8px;
      }
      
      /* Firefox-specific fixes */
      @-moz-document url-prefix() {
        #interactive {
          height: 50vh !important;
          min-height: 300px;
        }
        
        #interactive video {
          position: absolute;
          top: 0;
          left: 0;
          width: 100% !important;
          height: 100% !important;
        }
      }
      
      /* Enhanced scanner guides */
      #barcode-guide {
        z-index: 10 !important; 
      }
      
      /* Add these to the existing styles in the head section */
      @-moz-document url-prefix() {
        /* Firefox-specific zoom handling */
        #interactive video {
          transition: transform 0.2s ease;
        }
        
        /* Better guide display for Firefox */
        #barcode-guide {
          position: absolute !important;
          z-index: 20 !important;
        }
      }
      
      /* Make buttons more tappable */
      #zoomIn, #zoomOut {
        min-width: 40px;
        min-height: 36px;
      }
    </style>
</head>
<body class="bg-[#A7D4CC]">
    <!-- Login Section (Initially Visible) -->
    <div id="loginSection" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-[#E5D4F0] p-6 sm:p-8 rounded-lg shadow-md w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700">Username</label>
                    <input type="text" id="username" class="w-full p-2 border rounded" required>
                </div>
                <div>
                    <label class="block text-gray-700">Password</label>
                    <input type="password" id="password" class="w-full p-2 border rounded" required>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- Main Content (Initially Hidden) -->
    <div id="mainContent" class="hidden">
        <div class="main-container">
            <!-- Header with Today's Sale -->
            <div class="header-section">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="text-2xl sm:text-4xl font-bold text-gray-800" style="margin-right: 187px;">Today's Sale</div>
                    <div class="flex items-center gap-4">
                        <div class="text-2xl sm:text-4xl font-bold text-green-600 sales-amount">
                            ₹<span id="todaySaleAmount"
                            style="margin-right: 7.25rem;"
                            >0</span>
                        </div>
                        <div class="sales-arrow">→</div>
                        <button id="logoutBtn" class="menu-button p-2 sm:p-3">
                            <i class="fas fa-sign-out-alt text-lg sm:text-xl text-gray-700"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!--  Create Bill Section -->
            <div class="mb-8">
                <div class="section-title">Create Bill</div>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 sm:gap-8">
                    <button class="menu-button p-8 text-center" onclick="window.billingSystem.startNewBill()">
                        <div class="icon-container mx-auto">
                            <i class="fas fa-file-invoice text-3xl text-gray-700"></i>
                        </div>
                        <div class="menu-text text-xl">Billing</div>
                    </button>
                    <button class="menu-button p-8 text-center" onclick="billingSystem.showPastBills()">
                        <div class="icon-container mx-auto">
                            <i class="fas fa-history text-3xl text-gray-700"></i>
                        </div>
                        <div class="menu-text text-xl">Past Bills</div>
                    </button>
                    <button class="menu-button p-8 text-center" onclick="refundManager.showRefundModal()">
                        <div class="icon-container mx-auto">
                            <i class="fas fa-exchange-alt text-3xl text-gray-700"></i>
                        </div>
                        <div class="menu-text text-xl">Exchange/Refund</div>
                    </button>
                </div>
            </div>

            <!-- Product Section -->
            <div class="mb-20">
                <div class="section-title">Product</div>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 sm:gap-8">
                    <button class="menu-button p-8 text-center" onclick="productManager.showProductModal()">
                        <div class="icon-container mx-auto">
                            <i class="fas fa-box-open text-3xl text-gray-700"></i>
                        </div>
                        <div class="menu-text text-xl">Add product</div>
                    </button>
                    <button class="menu-button p-8 text-center" onclick="productManager.showProductList()">
                        <div class="icon-container mx-auto">
                            <i class="fas fa-list text-3xl text-gray-700"></i>
                        </div>
                        <div class="menu-text text-xl">Product List</div>
                    </button>
                    <button class="menu-button p-8 text-center" onclick="inventoryManager.showInventoryModal()">
                        <div class="icon-container mx-auto">
                            <i class="fas fa-warehouse text-3xl text-gray-700"></i>
                        </div>
                        <div class="menu-text text-xl">Inventory Management</div>
                    </button>
                </div>
            </div>

            <!-- Replace the Data Management section in the main interface -->
            <div class="mb-20">
                <div class="section-title">Data Management</div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-8">
                    <button class="menu-button p-8 text-center" onclick="window.settingsManager.showSettingsModal('data')">
                        <div class="icon-container mx-auto">
                            <i class="fas fa-database text-3xl text-gray-700"></i>
                        </div>
                        <div class="menu-text text-xl">Manage Data</div>
                    </button>
                    <button class="menu-button p-8 text-center" onclick="window.settingsManager.showSettingsModal()">
                        <div class="icon-container mx-auto">
                            <i class="fas fa-cog text-3xl text-gray-700"></i>
                        </div>
                        <div class="menu-text text-xl">Settings</div>
                    </button>
                </div>
            </div>

            <!-- Customer Section -->
            <div class="mb-20">
                <div class="section-title">Customer</div>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 sm:gap-8">
                    <button class="menu-button p-8 text-center" onclick="billManager.showBills()">
                        <div class="icon-container mx-auto">
                            <i class="fas fa-receipt text-3xl text-gray-700"></i>
                        </div>
                        <div class="menu-text text-xl">Bills</div>
                    </button>
                    <button class="menu-button p-8 text-center" onclick="refundManager.showRefundModal()">
                        <div class="icon-container mx-auto">
                            <i class="fas fa-exchange-alt text-3xl text-gray-700"></i>
                        </div>
                        <div class="menu-text text-xl">Exchange/Refund</div>
                    </button>
                    <button class="menu-button p-8 text-center" onclick="customerManager.showCustomerList()">
                        <div class="icon-container mx-auto">
                            <i class="fas fa-users text-3xl text-gray-700"></i>
                        </div>
                        <div class="menu-text text-xl">Customers</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="fixed bottom-0 left-0 right-0 bottom-nav">
            <div class="flex justify-between max-w-xs mx-auto px-2">
                <button class="nav-button menu-button">
                    <div class="nav-icon-container mx-auto">
                        <i class="fas fa-home nav-icon text-gray-700"></i>
                    </div>
                    <div class="nav-text">POS</div>
                </button>
                <button class="nav-button menu-button bg-blue-500 hover:bg-blue-600" onclick="billingSystem.showBillingModal()">
                    <div class="nav-icon-container mx-auto">
                        <i class="fas fa-plus nav-icon text-white"></i>
                    </div>
                    <div class="nav-text text-white">Bill</div>
                </button>
                <button class="nav-button menu-button" onclick="reportManager.showReports()">
                    <div class="nav-icon-container mx-auto">
                        <i class="fas fa-chart-bar nav-icon text-gray-700"></i>
                    </div>
                    <div class="nav-text">Reports</div>
                </button>
                <!-- Settings button removed as per user request -->
            </div>
        </div>
    </div>

    <!-- Billing Modal -->
    <div id="billingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto" data-generating-bill="false">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl mx-auto my-4 sm:my-8">
            <!-- Fixed Header -->
            <div class="sticky top-0 bg-white p-4 sm:p-6 border-b border-gray-200 z-10 rounded-t-lg">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Billing</h2>
                    <button class="modal-close text-gray-600 hover:text-gray-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Scrollable Content -->
            <div class="p-4 sm:p-6 max-h-[calc(100vh-16rem)] overflow-y-auto">
                <div class="space-y-4">
                    <!-- Barcode Scanner Input -->
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="col-span-2 relative">
                            <input type="text" id="barcodeInput" 
                                class="w-full p-2 border rounded" 
                                placeholder="Scan barcode or search product">
                            <div id="searchSuggestions" class="absolute z-10 w-full bg-white border rounded-b shadow-lg max-h-60 overflow-auto hidden">
                                <!-- Suggestions will be populated here -->
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button class="scan-barcode-btn bg-green-500 text-white p-2 rounded hover:bg-green-600 flex-1">
                                <i class="fas fa-barcode mr-2"></i>Scan
                            </button>
                            <button id="addManualItem" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 flex-1">
                                Add Item
                            </button>
                        </div>
                    </div>

                    <!-- Bill Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-2">#</th>
                                    <th class="p-2">Item</th>
                                    <th class="p-2">MRP</th>
                                    <th class="p-2">Rate</th>
                                    <th class="p-2">Qty</th>
                                    <th class="p-2">Total</th>
                                    <th class="p-2">Action</th>
                                </tr>
                            </thead>
                            <tbody id="billItems">
                                <!-- Bill items will be added here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Payment Mode -->
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Payment Mode</label>
                        <div class="flex gap-2">
                            <button type="button" id="cashPaymentBtn" 
                                class="payment-mode-btn px-4 py-2 rounded border hover:bg-gray-100"
                                data-mode="cash">
                                <i class="fas fa-money-bill-wave mr-2"></i>Cash
                            </button>
                            <button type="button" id="upiPaymentBtn" 
                                class="payment-mode-btn px-4 py-2 rounded border hover:bg-gray-100"
                                data-mode="upi">
                                <i class="fas fa-qrcode mr-2"></i>UPI
                            </button>
                            <button type="button" id="cardPaymentBtn" 
                                class="payment-mode-btn px-4 py-2 rounded border hover:bg-gray-100"
                                data-mode="card">
                                <i class="fas fa-credit-card mr-2"></i>Card
                            </button>
                        </div>
                    </div>

                    <!-- Bill Total -->
                    <div class="text-lg font-bold">
                        <div>Total: <span id="billTotal">₹0.00</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Fixed Footer -->
            <div class="sticky bottom-0 bg-white p-4 sm:p-6 border-t border-gray-200 rounded-b-lg">
                <!-- Action Buttons -->
                <div class="flex justify-end space-x-4">
                    <button id="clearBillBtn" 
                        class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        Clear Bill
                    </button>
                    <button id="generateBillBtn" 
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                        onclick="billingSystem.generateBill()">
                        Generate Bill
                    </button>
                    <button id="printBill" 
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                        onclick="billingSystem.printBill()">
                        Print
                    </button>
                    <button id="debugBillButton" class="hidden px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        Debug Bill
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl mx-2 sm:mx-auto my-4 sm:my-20">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Add Product</h2>
                <button class="modal-close text-gray-600 hover:text-gray-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="productForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700">Product Name</label>
                        <input type="text" name="productName" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Barcode</label>
                        <div class="flex gap-2">
                            <input type="text" id="productBarcode" class="w-full p-2 border rounded" placeholder="Enter product barcode">
                            <button type="button" id="scanProductBarcode" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 flex items-center">
                                <i class="fas fa-barcode mr-1"></i> Scan
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700">MRP</label>
                        <input type="number" name="mrp" id="mrp" 
                            class="w-full p-2 border rounded" 
                            step="any" min="0" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">Discount Type</label>
                        <select name="discountType" id="discountType" 
                            class="w-full p-2 border rounded" 
                            data-original-value=""
                            onchange="productManager.handleDiscountTypeChange(this)">
                            <option value="percentage">Percentage (%)</option>
                            <option value="amount">Fixed Amount (₹)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700">Discount</label>
                        <div class="relative">
                            <input type="text" name="discount" id="discount" 
                                class="w-full p-2 border rounded" 
                                value="0"
                                data-original-value="">
                            <span id="discountSymbol" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">
                                %
                            </span>
                        </div>
                        <span id="discountError" class="text-red-500 text-sm mt-1 hidden"></span>
                    </div>
                    <div>
                        <label class="block text-gray-700">Stock</label>
                        <div class="flex gap-2">
                            <input type="number" 
                                name="stock" 
                                class="w-full p-2 border rounded" 
                                step="0.001" 
                                min="0" 
                                required>
                            <select name="stockUnit" id="stockUnit" class="w-24 p-2 border rounded">
                                <option value="unit">Units</option>
                                <option value="kg">KG</option>
                                <option value="g">Grams</option>
                                <option value="lb">Pounds</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700">Product Type</label>
                        <select name="productType" id="productType" class="w-full p-2 border rounded">
                            <option value="unit">Unit Based</option>
                            <option value="weight">Weight Based</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700">Category</label>
                        <select name="category" id="productCategory" class="w-full p-2 border rounded">
                            <option value="">Select Category</option>
                            <option value="grains">Grains</option>
                            <option value="pulses">Pulses</option>
                            <option value="flour">Flour</option>
                            <option value="vegetables">Vegetables</option>
                            <option value="fruits">Fruits</option>
                            <option value="spices">Spices</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">GST Rate (%)</label>
                        <input 
                            type="number" 
                            name="gstRate" 
                            id="gstRate" 
                            class="mt-1 block w-full rounded-md border border-gray-300 p-2" 
                            data-original-value=""
                            min="0" 
                            max="100" 
                            step="0.01" 
                            placeholder="Enter GST rate (e.g. 5 for 5%)"
                        >
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                    Save Product
                </button>
            </form>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-6xl mx-auto my-8 max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-white py-2 z-10">
                <h2 class="text-2xl font-bold">Inventory Management</h2>
                <button class="modal-close text-gray-600 hover:text-gray-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Search Bar -->
            <div class="mb-4 sticky top-12 bg-white py-2 z-10">
                <div class="relative">
                    <input type="text" 
                        id="inventorySearch" 
                        placeholder="Search products..." 
                        class="w-full p-3 pl-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        oninput="inventoryManager.filterProducts(this.value)">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>

            <!-- Table Container -->
            <div class="mt-6">
                <div class="inline-block min-w-full align-middle">
                    <div class="overflow-hidden border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Product Name
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Barcode
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        MRP
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Stock
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="inventoryItems" class="bg-white divide-y divide-gray-200">
                                <!-- Example of how JavaScript should populate each row -->
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">Product Name Here</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-500">123456789</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <div class="text-sm text-gray-900">₹99.99</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <div class="flex items-center justify-end space-x-2">
                                            <input type="number" 
                                                class="w-20 px-2 py-1 text-right border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                value="50">
                                            <span class="text-sm text-gray-500">units</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <div class="flex items-center justify-center space-x-3">
                                            <button class="text-blue-600 hover:text-blue-900 transition-colors">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="text-red-600 hover:text-red-900 transition-colors">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product List Modal -->
    <div id="productListModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl mx-auto mt-20">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Product List</h2>
                <button class="modal-close text-gray-600 hover:text-gray-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <input type="text" id="productSearch" placeholder="Search products..." 
                    class="w-full p-2 border rounded">
            </div>
            <div class="overflow-auto max-h-96">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-2 text-left">Product Name</th>
                            <th class="p-2 text-center">Barcode</th>
                            <th class="p-2 text-right">MRP</th>
                            <th class="p-2 text-center">Stock</th>
                            <th class="p-2 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productListItems"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Past Bills Modal -->
    <div id="pastBillsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-6 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Past Bills</h2>
                    <div>
                        <button id="runStorageDiagnostic" class="text-sm px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 mr-2">
                            <i class="fas fa-stethoscope mr-1"></i> Diagnose
                        </button>
                        <button class="modal-close text-gray-600 hover:text-gray-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left">Bill No</th>
                                <th class="p-2 text-left">Date</th>
                                <th class="p-2 text-right">Amount</th>
                                <th class="p-2 text-center">Payment Mode</th>
                                <th class="p-2 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="pastBillsList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Modal -->
    <div id="reportsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto">
        <div class="min-h-screen px-4 py-6">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Today's Reports</h2>
                    <button class="modal-close text-gray-600 hover:text-gray-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-100 p-4 rounded">
                        <div class="text-lg font-semibold">Total Sales</div>
                        <div class="text-2xl">₹<span id="todaySales">0</span></div>
                    </div>
                    <div class="bg-green-100 p-4 rounded">
                        <div class="text-lg font-semibold">Total Bills</div>
                        <div class="text-2xl" id="totalBills">0</div>
                    </div>
                    <div id="totalItemsCard" class="bg-yellow-100 p-4 rounded cursor-pointer hover:bg-yellow-200">
                        <div class="text-lg font-semibold">Total Items</div>
                        <div class="text-2xl" id="totalItems">0</div>
                        <div class="text-sm text-gray-600">(Click to see details)</div>
                    </div>
                    <div class="bg-purple-100 p-4 rounded">
                        <div class="text-lg font-semibold">Average Bill Value</div>
                        <div class="text-2xl">₹<span id="avgBillValue">0</span></div>
                    </div>
                </div>

                <!-- Updated Items Detail Section -->
                <div id="itemsDetailSection" class="mt-6 hidden">
                    <div class="bg-white rounded-lg shadow">
                        <!-- Period Selection -->
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-800">Detailed Sales Report</h3>
                                <div class="flex gap-2">
                                    <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 active">Today</button>
                                    <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">Week</button>
                                    <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">Month</button>
                                </div>
                            </div>
                        </div>

                        <!-- Table Section -->
                        <div class="overflow-x-auto">
                            <div class="inline-block min-w-full align-middle">
                                <div class="overflow-hidden">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Item Name
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Unit Price
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Quantity Sold
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Total Revenue
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="itemsSoldList" class="bg-white divide-y divide-gray-200">
                                            <!-- Rows will be populated by JavaScript -->
                                        </tbody>
                                        <tfoot class="bg-gray-50 font-semibold">
                                            <tr>
                                                <td colspan="2" class="px-6 py-4 text-sm text-right text-gray-900">
                                                    Grand Total
                                                </td>
                                                <td class="px-6 py-4 text-right text-sm text-gray-900" id="totalQuantity">
                                                    0
                                                </td>
                                                <td class="px-6 py-4 text-right text-sm text-gray-900" id="grandTotal">
                                                    ₹0
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Summary Section -->
                        <div class="grid grid-cols-3 gap-4 p-4 bg-gray-50 border-t border-gray-200">
                            <div class="text-center">
                                <div class="text-sm font-medium text-gray-500">Total Items</div>
                                <div class="mt-1 text-xl font-semibold text-gray-900" id="summaryTotalItems">0</div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm font-medium text-gray-500">Average Price</div>
                                <div class="mt-1 text-xl font-semibold text-gray-900" id="summaryAvgPrice">₹0</div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm font-medium text-gray-500">Total Revenue</div>
                                <div class="mt-1 text-xl font-semibold text-gray-900" id="summaryTotalRevenue">₹0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="scannerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="bg-white p-4 rounded-lg shadow-lg w-full max-w-xl mx-auto my-4 sm:my-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl sm:text-2xl font-bold">Scan Products</h2>
                <button class="modal-close text-gray-600 hover:text-gray-800 p-2 touch-manipulation">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="flex flex-col gap-3 sm:gap-4">
                <!-- Scanner section - Responsive height based on viewport -->
                <div id="interactive" class="w-full h-64 sm:h-80 md:h-96 bg-gray-100 flex items-center justify-center rounded overflow-hidden">
                    <!-- Loading message will be replaced by camera feed -->
                    <div class="text-gray-500">Loading camera...</div>
                </div>
                <div id="scannerControls" class="flex flex-wrap sm:flex-nowrap justify-between items-center gap-2">
                    <div class="flex gap-2">
                        <button id="toggleFlash" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded touch-manipulation min-w-[40px]">
                            <i class="fas fa-bolt"></i> <span class="hidden sm:inline">Flash</span>
                        </button>
                        <button id="switchCamera" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded touch-manipulation min-w-[40px]">
                            <i class="fas fa-sync"></i> <span class="hidden sm:inline">Switch</span>
                        </button>
                    </div>
                    <div>
                        <select id="scannerResolution" class="p-2 border rounded touch-manipulation">
                            <option value="hd">HD Resolution</option>
                            <option value="vga">VGA Resolution</option>
                            <option value="qvga" selected>Fast (QVGA)</option>
                        </select>
                    </div>
                </div>
                <div id="scanResult" class="mt-1 text-center text-gray-700 font-bold min-h-[24px]"></div>
                
                <!-- Scanner Bill Section -->
                <div id="scannerBillSection" class="mt-2">
                    <div class="bg-gray-50 rounded-lg p-3 sm:p-4">
                        <div class="flex flex-col gap-2">
                            <div class="flex flex-wrap sm:flex-nowrap justify-between items-center gap-2">
                                <h3 class="text-base sm:text-lg font-bold">Scanned Items</h3>
                                <button id="completeBill" class="bg-green-500 text-white px-3 sm:px-4 py-2 rounded hover:bg-green-600 touch-manipulation w-full sm:w-auto">
                                    Add to Current Bill
                                </button>
                            </div>
                            <p class="text-xs sm:text-sm text-gray-600">Items will be merged with your existing bill</p>
                        </div>
                        <div class="max-h-32 sm:max-h-48 overflow-auto mt-2 rounded border">
                            <table class="w-full min-w-full">
                                <thead class="bg-gray-100 sticky top-0">
                                    <tr>
                                        <th class="text-left p-2 text-xs sm:text-sm">Item</th>
                                        <th class="text-right p-2 text-xs sm:text-sm">MRP</th>
                                        <th class="text-right p-2 text-xs sm:text-sm">Rate</th>
                                        <th class="text-center p-2 text-xs sm:text-sm">Qty</th>
                                        <th class="text-right p-2 text-xs sm:text-sm">Total</th>
                                        <th class="text-center p-2 text-xs sm:text-sm">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="scannerBillItems"></tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-right font-bold">
                            Total: ₹<span id="scannerBillTotal">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-6 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Settings</h2>
                    <button class="modal-close text-gray-600 hover:text-gray-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="settingsForm" class="space-y-6">
                    <!-- Store Details Tab -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold border-b pb-2">Store Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Store Name</label>
                                <input type="text" name="storeName" class="mt-1 block w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Store Tagline</label>
                                <input type="text" name="storeTagline" class="mt-1 block w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Branch Name</label>
                                <input type="text" name="branchName" class="mt-1 block w-full p-2 border rounded" 
                                       placeholder="DMART BRANCH">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">City & PIN</label>
                                <input type="text" name="storeCity" class="mt-1 block w-full p-2 border rounded"
                                       placeholder="Ahmedabad - 380005">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">Store Address</label>
                                <textarea name="storeAddress" rows="2" class="mt-1 block w-full p-2 border rounded"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                                <input type="text" name="storePhone" class="mt-1 block w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Cashier Prefix</label>
                                <input type="text" name="cashierPrefix" class="mt-1 block w-full p-2 border rounded" 
                                       placeholder="MJA">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Employee ID</label>
                                <input type="text" name="employeeId" class="mt-1 block w-full p-2 border rounded" 
                                       placeholder="076175">
                            </div>
                        </div>
                    </div>
                    
                    <!-- GST Settings Tab -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold border-b pb-2">GST Settings</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">GSTIN</label>
                                <input type="text" name="storeGSTIN" class="mt-1 block w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Default GST Rate (%)</label>
                                <input type="number" name="defaultGSTRate" step="0.1" min="0" max="28" class="mt-1 block w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">CIN</label>
                                <input type="text" name="storeCIN" class="mt-1 block w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">FSSAI Number</label>
                                <input type="text" name="storeFSSAI" class="mt-1 block w-full p-2 border rounded">
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="showGSTBreakdown" id="showGSTBreakdown" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label for="showGSTBreakdown" class="ml-2 block text-sm text-gray-700">Show GST Breakdown on Receipts</label>
                        </div>
                    </div>
                    
                    <!-- Receipt Settings Tab -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold border-b pb-2">Receipt Settings</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Receipt Format</label>
                                <select name="receiptFormat" class="mt-1 block w-full p-2 border rounded">
                                    <option value="standard">Standard</option>
                                    <option value="detailed">Detailed</option>
                                    <option value="gst">GST (D-Mart Style)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Print Timeout (ms)</label>
                                <input type="number" name="printTimeout" min="100" max="2000" class="mt-1 block w-full p-2 border rounded">
                            </div>
                            <!-- Add UPI Address field -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">UPI Address</label>
                                <input type="text" name="upiAddress" class="mt-1 block w-full p-2 border rounded" placeholder="example@upi">
                                <p class="text-xs text-gray-500 mt-1">Used for generating UPI QR codes for payments</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="autoPrint" id="autoPrint" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label for="autoPrint" class="ml-2 block text-sm text-gray-700">Auto-print receipts</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="showSavings" id="showSavings" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label for="showSavings" class="ml-2 block text-sm text-gray-700">Show savings on MRP</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="roundTotals" id="roundTotals" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label for="roundTotals" class="ml-2 block text-sm text-gray-700">Round totals to nearest rupee</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="showMrpColumn" id="showMrpColumn" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label for="showMrpColumn" class="ml-2 block text-sm text-gray-700">Show MRP column in D-Mart receipts</label>
                        </div>
                        <!-- Add HSN column toggle under receipt settings -->
                        <div class="flex items-center mt-2">
                            <input type="checkbox" name="showHsnColumn" id="showHsnColumn" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label for="showHsnColumn" class="ml-2 block text-sm text-gray-700">Show HSN column in D-Mart receipts</label>
                        </div>
                    </div>
                    
                    <!-- Replace the Data Management Tab in Settings Modal -->
                    <div class="space-y-4 data-management-section">
                        <h3 class="text-lg font-semibold border-b pb-2">Data Management</h3>
                        
                        <div class="p-4 bg-white rounded-lg shadow border border-gray-200">
                            <h4 class="font-medium text-lg mb-4">Backup & Restore</h4>
                            
                            <div class="grid grid-cols-1 gap-4">
                                <div class="bg-blue-50 p-4 rounded border border-blue-200">
                                    <h5 class="text-blue-700 font-medium mb-2">Backup Your Data</h5>
                                    <p class="text-sm text-gray-600 mb-3">Create a backup file containing all your products, sales, and settings.</p>
                                    <button onclick="createBackup()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 w-full sm:w-auto">
                                    <i class="fas fa-download mr-2"></i>Download Backup
                                </button>
                            </div>
                            
                                <div class="bg-green-50 p-4 rounded border border-green-200">
                                    <h5 class="text-green-700 font-medium mb-2">Restore From Backup</h5>
                                    <p class="text-sm text-gray-600 mb-3">Load a previous backup file to restore your data.</p>
                                    <label for="restoreFileInput" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 inline-block cursor-pointer w-full sm:w-auto text-center">
                                        <i class="fas fa-upload mr-2"></i>Select Backup File
                                    </label>
                                    <input type="file" id="restoreFileInput" accept=".json" class="hidden">
                            </div>
                            
                                <div class="bg-red-50 p-4 rounded border border-red-200">
                                    <h5 class="text-red-700 font-medium mb-2">Delete All Data</h5>
                                    <p class="text-sm text-gray-600 mb-3">Warning: This will permanently delete all your data and cannot be undone.</p>
                                    <button id="clearDataBtn" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 w-full sm:w-auto">
                                        <i class="fas fa-trash mr-2"></i>Delete All Data
                                </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="resetSettings" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-100">
                            Reset to Defaults
                        </button>
                        <button type="submit" id="saveSettings" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Save Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Calculator Modal -->
    <div id="changeCalculatorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-6 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Change Calculator</h2>
                    <button class="modal-close text-gray-600 hover:text-gray-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div class="flex flex-col space-y-2">
                        <label class="text-lg font-medium">Bill Amount</label>
                        <div class="text-2xl font-bold">₹<span id="calculatorBillAmount">0.00</span></div>
                    </div>
                    
                    <div class="flex flex-col space-y-2">
                        <label for="amountReceived" class="text-lg font-medium">Amount Received</label>
                        <div class="relative flex-1">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">₹</span>
                            <input type="number" id="amountReceived" 
                                class="w-full p-3 pl-8 text-xl border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                placeholder="0.00" step="any" min="0">
                        </div>
                    </div>
                    
                    <div class="flex flex-col space-y-2 p-4 bg-green-50 rounded-lg" id="changeResultContainer">
                        <label class="text-lg font-medium">Change to Return</label>
                        <div class="text-3xl font-bold text-green-600">₹<span id="changeAmount">0.00</span></div>
                    </div>
                    
                    <div class="flex justify-between space-x-3 pt-4 border-t">
                        <button id="resetCalculator" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-100">
                            Reset
                        </button>
                        <button id="confirmPayment" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                            Confirm & Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- UPI QR Code Modal -->
    <div id="upiQrModal" class="fixed inset-0 bg-gray-800 bg-opacity-80 hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-6 flex items-center justify-center">
            <div class="bg-white p-0 rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                <!-- Header with gradient background -->
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 py-5 px-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-white flex items-center">
                            <i class="fas fa-qrcode mr-3"></i>UPI Payment
                        </h2>
                        <button class="modal-close text-white hover:text-gray-200 focus:outline-none">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- Amount display with card-like design -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
                        <p class="text-gray-500 text-sm uppercase tracking-wide font-medium">Amount to Pay</p>
                        <div class="text-3xl font-bold text-gray-800 mt-1">₹<span id="upiPaymentAmount">0.00</span></div>
                    </div>
                    
                    <!-- QR Container with improved styling -->
                    <div class="bg-gradient-to-b from-blue-50 to-purple-50 rounded-xl p-6 flex flex-col items-center">
                        <div class="mb-4 text-center">
                            <p class="text-lg font-medium text-gray-700">Scan with any UPI App</p>
                            <div class="flex justify-center mt-2 space-x-3">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f2/Google_Pay_Logo.svg/512px-Google_Pay_Logo.svg.png" 
                                     alt="Google Pay" class="h-6">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/24/Paytm_Logo_%28standalone%29.svg/512px-Paytm_Logo_%28standalone%29.svg.png" 
                                     alt="Paytm" class="h-6">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/7/71/PhonePe_Logo.svg" 
                                     alt="PhonePe" class="h-6">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/UPI-Logo-vector.svg/512px-UPI-Logo-vector.svg.png" 
                                     alt="UPI" class="h-6">
                            </div>
                        </div>
                        
                        <div id="upiQrCodeContainer" class="p-4 bg-white rounded-lg shadow-lg border border-gray-200 flex items-center justify-center" style="min-height: 260px; min-width: 260px">
                            <!-- QR Code will be generated here -->
                            <div class="text-center">
                                <div class="animate-pulse flex flex-col items-center">
                                    <div class="rounded-full bg-blue-100 h-16 w-16 flex items-center justify-center mb-3">
                                        <i class="fas fa-qrcode text-blue-500 text-3xl"></i>
                                    </div>
                                    <div class="h-4 bg-blue-100 rounded w-24 mb-2.5"></div>
                                    <div class="h-3 bg-blue-100 rounded w-16"></div>
                                </div>
                                <p class="text-sm text-gray-500 mt-4">Generating secure QR code...</p>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <p id="upiIdDisplay" class="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full inline-block">
                                <i class="fas fa-user-shield text-gray-400 mr-1"></i> <span>Loading...</span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Data privacy notice -->
                    <div class="mt-4 text-xs text-gray-500 text-center">
                        <p><i class="fas fa-shield-alt mr-1"></i> Your payment data is secure and not stored by us</p>
                    </div>
                    
                    <!-- Action buttons -->
                    <div class="flex justify-between space-x-3 pt-4 mt-4 border-t">
                        <button id="closeUpiModal" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                            <i class="fas fa-arrow-left mr-1"></i> Cancel
                        </button>
                        <button id="confirmUpiPayment" class="px-5 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 transition-colors font-medium">
                            <i class="fas fa-check mr-1"></i> Payment Complete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refund/Exchange Modal -->
    <div id="refundModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Process Exchange/Refund</h2>
                    <button class="modal-close text-gray-600 hover:text-gray-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Tab Navigation -->
                <div class="mb-6 border-b">
                    <div class="flex space-x-4">
                        <button id="findBillTab" class="px-4 py-2 border-b-2 border-blue-500 text-blue-500 font-medium">
                            Find Bill
                        </button>
                        <button id="selectItemsTab" class="px-4 py-2 text-gray-500 font-medium" disabled>
                            Select Items
                        </button>
                        <button id="processRefundTab" class="px-4 py-2 text-gray-500 font-medium" disabled>
                            Process Refund
                        </button>
                        <button id="refundRecordsTab" class="px-4 py-2 text-gray-500 font-medium">
                            Records
                        </button>
                    </div>
                </div>
                
                <!-- Step 1: Find Bill Tab -->
                <div id="findBillSection" class="refund-tab-content">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search by Bill Number or Phone Number</label>
                        <div class="flex space-x-2">
                            <input type="text" id="refundBillSearch" class="flex-1 p-2 border rounded" placeholder="Enter bill number or customer phone">
                            <button id="searchBillBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                <i class="fas fa-search mr-2"></i>Search
                            </button>
                        </div>
                    </div>
                    
                    <!-- Make the bill search results scrollable -->
                    <div id="billSearchResults" class="mt-4 border rounded-lg overflow-hidden hidden max-h-[50vh] overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bill #</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Action</th>
                                </tr>
                            </thead>
                            <tbody id="refundBillList" class="bg-white divide-y divide-gray-200">
                                <!-- Bills will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 text-sm text-gray-500">
                        Select a bill to proceed with refund or exchange.
                    </div>
                </div>
                
                <!-- Step 2: Select Items Tab -->
                <div id="selectItemsSection" class="refund-tab-content hidden">
                    <div class="mb-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium">Bill Details:</h3>
                            <span class="text-sm text-gray-500">Bill #<span id="selectedBillNumber">-</span></span>
                        </div>
                        <div class="text-sm text-gray-500 mt-1">
                            Date: <span id="selectedBillDate">-</span> | Amount: <span id="selectedBillAmount">-</span>
                        </div>
                    </div>
                    
                    <!-- Make the items selection table scrollable -->
                    <div class="mt-6">
                        <h3 class="text-lg font-medium mb-2">Select Items for Refund/Exchange</h3>
                        <div class="border rounded-lg overflow-hidden max-h-[50vh] overflow-y-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            <input type="checkbox" id="selectAllItems" class="form-checkbox h-4 w-4 text-blue-600">
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Item</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Qty</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Price</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="refundItemsList" class="bg-white divide-y divide-gray-200">
                                    <!-- Items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-between">
                        <button id="backToBillsBtn" class="px-4 py-2 border rounded text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-arrow-left mr-2"></i>Back
                        </button>
                        <button id="continueToRefundBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Continue<i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Process Refund Tab -->
                <div id="processRefundSection" class="refund-tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-4">Refund/Exchange Details</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Type</label>
                                <div class="flex space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="transactionType" value="refund" checked class="h-4 w-4 text-blue-600">
                                        <span class="ml-2">Refund</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="transactionType" value="exchange" class="h-4 w-4 text-blue-600">
                                        <span class="ml-2">Exchange</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Refund Amount</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">₹</span>
                                    <input type="text" id="refundAmount" class="w-full p-2 pl-8 border rounded" readonly>
                                </div>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Reason for Return/Exchange</label>
                                <select id="refundReason" class="w-full p-2 border rounded">
                                    <option value="">Select a reason</option>
                                    <option value="defective">Product Defective</option>
                                    <option value="wrong-item">Wrong Item</option>
                                    <option value="not-as-described">Not As Described</option>
                                    <option value="changed-mind">Customer Changed Mind</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
                                <textarea id="refundNotes" class="w-full p-2 border rounded" rows="3" placeholder="Enter any additional details about this refund/exchange"></textarea>
                            </div>
                            
                            <div id="exchangeItemsSection" class="md:col-span-2 hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Exchange Items</label>
                                <div class="text-sm">
                                    <button id="addExchangeItems" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                                        <i class="fas fa-plus mr-1"></i>Add Exchange Items
                                    </button>
                                    <div id="exchangeItemsList" class="mt-2 border rounded p-2 hidden">
                                        <!-- Exchange items will go here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-between">
                        <button id="backToItemsBtn" class="px-4 py-2 border rounded text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-arrow-left mr-2"></i>Back
                        </button>
                        <button id="processRefundBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                            <i class="fas fa-check mr-2"></i>Complete Refund/Exchange
                        </button>
                    </div>
                </div>

                <!-- Step 4: Refund Records Tab -->
                <div id="refundRecordsSection" class="refund-tab-content hidden">
                    <div class="mb-4 flex justify-between items-center">
                        <h3 class="text-lg font-medium">Refund & Exchange Records</h3>
                        <div class="flex space-x-2">
                            <select id="refundRecordFilter" class="text-sm border rounded px-2 py-1">
                                <option value="all">All Records</option>
                                <option value="refund">Refunds Only</option>
                                <option value="exchange">Exchanges Only</option>
                            </select>
                            <input type="text" id="refundRecordSearch" class="text-sm border rounded px-2 py-1" placeholder="Search...">
                        </div>
                    </div>
                    
                    <!-- Add max-h-[60vh] and overflow-y-auto to make the table scrollable -->
                    <div class="border rounded-lg overflow-hidden max-h-[60vh] overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Bill #</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Details</th>
                                </tr>
                            </thead>
                            <tbody id="refundRecordsList" class="bg-white divide-y divide-gray-200">
                                <!-- Records will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="refundRecordPagination" class="mt-4 flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            Showing <span id="refundRecordsShowing">0</span> of <span id="refundRecordsTotal">0</span> records
                        </div>
                        <div class="flex space-x-2">
                            <button id="refundRecordsPrevPage" class="px-3 py-1 border rounded text-sm disabled:opacity-50">
                                Previous
                            </button>
                            <button id="refundRecordsNextPage" class="px-3 py-1 border rounded text-sm disabled:opacity-50">
                                Next
                            </button>
                        </div>
                    </div>
                    
                    <!-- Record Detail Modal - Completely redesigned for foolproof scrolling -->
                    <!-- Removing this modal as per user request (div[13]) -->
                    <!-- <div id="refundRecordDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-[100]">
                        <div class="absolute inset-0 overflow-hidden flex items-center justify-center p-4">
                            <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl flex flex-col max-h-[90vh] h-auto">
                                <!-- Fixed Header -->
                                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 flex justify-between items-center flex-shrink-0 rounded-t-lg">
                                    <h3 class="text-xl font-bold" id="recordDetailTitle">Refund Details</h3>
                                    <button id="closeRecordDetailBtn" class="text-white hover:bg-blue-700 hover:bg-opacity-25 p-1 rounded-full transition-colors">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                
                                <!-- Scrollable Content Area -->
                                <div id="refundRecordDetailContent" class="overflow-auto flex-grow px-6 py-6 refund-detail-content">
                                    <!-- Content will be populated here -->
                                </div>
                                
                                <!-- Fixed Footer -->
                                <div class="border-t border-gray-200 px-6 py-3 bg-gray-50 flex-shrink-0 rounded-b-lg">
                                    <div class="flex justify-end">
                                        <button id="closeModalBtn" class="px-4 py-2 border border-gray-300 rounded text-gray-600 hover:bg-gray-100 mr-2">
                                            Close
                                        </button>
                                        <button id="printModalRecordBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                            <i class="fas fa-print mr-2"></i> Print Receipt
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add QR Code library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    
    <!-- Scripts in correct loading order -->
    <script src="js/settings.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/bills.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/products.js"></script>
    <script src="js/inventory.js"></script>
    <script src="js/billing.js"></script>
    <!-- Updated HTML5 QR Code library with specific version and defer attribute -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" defer></script>
    <!-- Load scanner.js after HTML5 QR Code with defer to ensure proper sequence -->
    <script src="js/scanner.js" defer></script>
    <script src="js/reports.js"></script>
    <script src="js/main.js"></script>
    <script src="js/refund.js"></script>

    <!-- Add this script block right before the closing </body> tag -->
    <script>
        // Replace the current createBackup function with this more resilient version
        function createBackup() {
            console.log('Direct backup function called');
            
            try {
                // First try to use the storageManager
                if (window.storageManager && typeof window.storageManager.backupData === 'function') {
                    console.log('Using storageManager.backupData()');
                    window.storageManager.backupData();
                    return;
                }
                
                console.warn('StorageManager not available or missing backupData method, using emergency backup');
                
                // Emergency backup logic
                // Get products
                let products = [];
                try {
                    if (window.productManager && Array.isArray(window.productManager.products)) {
                        products = window.productManager.products;
                    } else {
                        products = JSON.parse(localStorage.getItem('products') || '[]');
                    }
                    console.log(`Got ${products.length} products`);
                } catch (err) {
                    console.error('Error getting products for backup:', err);
                    products = [];
                }
                
                // Get bills
                let bills = [];
                try {
                    if (window.billManager && Array.isArray(window.billManager.bills)) {
                        bills = window.billManager.bills;
                    } else {
                        bills = JSON.parse(localStorage.getItem('bills') || '[]');
                    }
                    console.log(`Got ${bills.length} bills`);
                } catch (err) {
                    console.error('Error getting bills for backup:', err);
                    bills = [];
                }
                
                // Get settings
                let settings = {};
                try {
                    if (window.settingsManager && window.settingsManager.settings) {
                        settings = window.settingsManager.settings;
                    } else {
                        settings = JSON.parse(localStorage.getItem('settings') || '{}');
                    }
                    console.log('Got settings');
                } catch (err) {
                    console.error('Error getting settings for backup:', err);
                    settings = {};
                }
                
                const backupData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    products: products,
                    bills: bills,
                    settings: settings
                };
                
                const jsonData = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pos_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('Emergency backup completed successfully');
                alert('Backup created successfully');
            } catch (error) {
                console.error('Backup failed:', error);
                alert('Failed to create backup: ' + error.message);
            }
        }

        // Replace the restore input handler with this more resilient version
        const restoreInput = document.getElementById('restoreFileInput');
        if (restoreInput) {
            restoreInput.addEventListener('change', function(e) {
                console.log('Restore file selected');
                const file = e.target.files[0];
                if (!file) {
                    console.error('No file selected');
                    return;
                }
                
                console.log('Processing file:', file.name);
                
                // Verify it's a JSON file
                if (!file.name.endsWith('.json')) {
                    alert('Please select a valid JSON backup file.');
                    this.value = ''; // Reset input
                    return;
                }
                
                try {
                    // First try using storage manager
                    if (window.storageManager && typeof window.storageManager.handleBackupFileUpload === 'function') {
                        console.log('Using storageManager.handleBackupFileUpload');
                        window.storageManager.handleBackupFileUpload(file);
                    } else {
                        console.warn('No storage manager available, using emergency restore');
                        // Emergency restore function
                        emergencyRestore(file);
                    }
                } catch (error) {
                    console.error('Error handling restore:', error);
                    alert('Failed to process backup file: ' + error.message);
                }
                
                // Reset the file input regardless of outcome
                this.value = '';
            });
        }

        function emergencyRestore(file) {
            console.log('Using emergency restore function');
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (!confirm('This will replace all your current data. Continue?')) {
                        return;
                    }
                    
                    // Restore products
                    if (data.products && Array.isArray(data.products)) {
                        console.log(`Restoring ${data.products.length} products`);
                        localStorage.setItem('products', JSON.stringify(data.products));
                    }
                    
                    // Restore bills
                    if (data.bills && Array.isArray(data.bills)) {
                        console.log(`Restoring ${data.bills.length} bills`);
                        localStorage.setItem('bills', JSON.stringify(data.bills));
                    }
                    
                    // Restore settings
                    if (data.settings) {
                        console.log('Restoring settings');
                        localStorage.setItem('settings', JSON.stringify(data.settings));
                    }
                    
                    alert('Data restored successfully! The page will now reload.');
                    setTimeout(() => location.reload(), 1000);
                    
                } catch (error) {
                    console.error('Error parsing backup file:', error);
                    alert('Invalid backup file format: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                console.error('Error reading file');
                alert('Error reading file');
            };
            
            reader.readAsText(file);
        }

        // Ensure critical managers are initialized
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Checking for critical managers...');
            
            // Check and initialize billManager if missing
            if (!window.billManager) {
                console.warn('billManager not found! Creating emergency instance.');
                try {
                    // Try to load bills from localStorage
                    const savedBills = JSON.parse(localStorage.getItem('bills') || '[]');
                    window.billManager = {
                        bills: savedBills,
                        addBill: function(bill) {
                            this.bills.push(bill);
                            localStorage.setItem('bills', JSON.stringify(this.bills));
                        }
                    };
                    console.log('Emergency billManager created with', savedBills.length, 'bills');
                } catch (err) {
                    console.error('Error creating emergency billManager:', err);
                    window.billManager = { bills: [] };
                }
            }
            
            // Similar checks for other managers...
            if (!window.productManager) {
                console.warn('productManager not found! Creating emergency instance.');
                try {
                    const savedProducts = JSON.parse(localStorage.getItem('products') || '[]');
                    window.productManager = { products: savedProducts };
                    console.log('Emergency productManager created with', savedProducts.length, 'products');
                } catch (err) {
                    console.error('Error creating emergency productManager:', err);
                    window.productManager = { products: [] };
                }
            }
            
            console.log('Critical manager check completed');

            // Check and fix settings manager
            if (window.settingsManager) {
                console.log('SettingsManager exists');
                
                // Add loadSettings method if it doesn't exist
                if (typeof window.settingsManager.loadSettings !== 'function') {
                    console.warn('Adding missing loadSettings method to settingsManager');
                    
                    window.settingsManager.loadSettings = function() {
                        console.log('Emergency loadSettings method called');
                        try {
                            // Get settings from localStorage
                            const savedSettings = localStorage.getItem('settings');
                            const parsedSettings = savedSettings ? JSON.parse(savedSettings) : {};
                            
                            // Apply them to the settingsManager object
                            if (this.defaultSettings) {
                                this.settings = { ...this.defaultSettings, ...parsedSettings };
                            } else {
                                this.settings = parsedSettings;
                            }
                            
                            // Try to update UI if form exists
                            if (typeof this.populateSettingsForm === 'function') {
                                this.populateSettingsForm();
                            }
                            
                            return true;
                        } catch (error) {
                            console.error('Error in emergency loadSettings:', error);
                            return false;
                        }
                    };
                }
            } else {
                console.warn('SettingsManager not found, creating emergency instance');
                
                // Create minimal settings manager
                window.settingsManager = {
                    settings: JSON.parse(localStorage.getItem('settings') || '{}'),
                    defaultSettings: {
                        storeName: "Your Store Name",
                        storeAddress: "Store Address",
                        storePhone: "Phone Number"
                    },
                    loadSettings: function() {
                        console.log('Emergency loadSettings called on stub object');
                        this.settings = JSON.parse(localStorage.getItem('settings') || '{}');
                    },
                    saveSettings: function(newSettings) {
                        if (newSettings) this.settings = { ...newSettings };
                        localStorage.setItem('settings', JSON.stringify(this.settings));
                    }
                };
            }
        });
    </script>
</body>
</html>